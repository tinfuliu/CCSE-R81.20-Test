
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CCTE 測驗 v1.1（內嵌題庫）</title>
<style>
  :root { --bg:#0b1020; --fg:#e7ebff; --card:#141a33; --muted:#99a2d0; --accent:#6aa0ff; }
  body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Noto Sans,'Apple Color Emoji','Segoe UI Emoji'; background:var(--bg); color:var(--fg); }
  header { padding:18px 20px; border-bottom:1px solid #1f2748; position:sticky; top:0; background:linear-gradient(#0b1020,#0b1020cc); backdrop-filter: blur(4px); z-index:10; }
  h1 { font-size:20px; margin:0 0 6px 0; }
  .muted { color: var(--muted); }
  main { max-width: 1100px; margin: 24px auto; padding: 0 16px 40px; }
  .toolbar { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:16px; }
  .toolbar > * { background: var(--card); border: 1px solid #1f2748; color: var(--fg); border-radius: 10px; padding:10px 12px; }
  select, input { outline:none; }
  button { cursor:pointer; transition: all .2s ease; }
  button:hover { transform: translateY(-1px); box-shadow: 0 4px 18px rgba(0,0,0,.25); }
  .card { background: var(--card); border:1px solid #1f2748; border-radius: 16px; padding:16px; margin:10px 0 18px; }
  .qhead { display:flex; justify-content:space-between; align-items:baseline; gap:10px; margin-bottom:8px; }
  .qid { font-weight:600; color:#cfd6ff; }
  .qstats { font-size:12px; color:#9ab0ff; }
  .qtxt { font-size:18px; line-height:1.45; white-space:pre-wrap; }
  .choices { display:grid; grid-template-columns:1fr; gap:8px; margin-top:10px; }
  .choice { border:1px solid #2a345f; border-radius:12px; padding:10px; cursor:pointer; }
  .choice.selected { border-color: var(--accent); background: #0d1530; }
  .choice.correct { border-color: #42cd7f; background: #0f2a1a; }
  .choice.wrong { border-color: #ff6b6b; background: #2a1111; }
  .choice.locked { opacity: .7; cursor: not-allowed; }
  .row { display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
  .pill { background:#0f1a3a; border:1px solid #2a345f; border-radius:999px; padding:6px 10px; font-size:12px; color:#cfd6ff; }
  .footer { display:flex; justify-content:space-between; align-items:center; gap:12px; }
  .btn { background: #203162; border:1px solid #40549b; color:white; border-radius:10px; padding:10px 14px; cursor:pointer; }
  .btn.secondary { background: transparent; border-color:#334279; color:#cfd6ff; }
  .btn.review { background:#2a2142; border-color:#7e5bef; }
  .btn.review.active { background:#3b2f6b; border-color:#a58bff; box-shadow: 0 0 0 2px rgba(165,139,255,.25) inset; }
  .btn.disabled { opacity: .5; cursor: not-allowed; }
  .danger { background:#3a1620; border-color:#a33; }
  .scoreBanner { background:#0f1a3a; border:1px solid #2a345f; border-radius:14px; padding:10px 12px; margin:10px 0; font-weight:600; }
  .searchBox { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .searchInput { width:240px; }
  .hidden { display:none; }
  .summary { display:flex; flex-direction:column; gap:6px; }
</style>
</head>
<body>
<header>
  <h1>CCTE 測驗 v1.1 <span class="muted">— 內嵌題庫</span></h1>
  <div class="muted" id="hdrMeta"></div>
</header>
<main>
  <section class="card">
    <div class="row">
      <div class="toolbar">
        <label>模式
          <select id="mode">
            <option value="exam">Exam（考試模式）</option>
            <option value="review_list">Review List（複習清單：隨機）</option>
            <option value="review_list_all">Review List（複習清單：全部）</option>
            <option value="search">Search（關鍵字找題）</option>
          </select>
        </label>
        <label id="countWrap">題數
          <select id="count">
            <option>5</option>
            <option>10</option>
            <option selected>20</option>
            <option>50</option>
            <option>100</option>
          </select>
        </label>
        <label id="rangeWrap">題號範圍
          <input id="rangeFrom" type="number" min="1" placeholder="起(如50)" style="width:90px" />
          <span>—</span>
          <input id="rangeTo" type="number" min="1" placeholder="迄(如100)" style="width:90px" />
        </label>
        <div class="searchBox" id="searchWrap">
          <input id="searchInput" class="searchInput" type="text" placeholder="關鍵字（多字詞以空白分隔）">
          <button class="btn secondary" id="searchBtn">搜尋</button>
          <button class="btn secondary" id="clearSearchBtn">清除</button>
        </div>
        <label><input type="checkbox" id="toggleOriginal"> 顯示原始題號</label>
        <button class="btn" id="startBtn">開始</button>
        <button class="btn secondary" id="resetBtn">重置複習清單/統計</button>
      </div>
      <div class="row">
        <div class="scoreBanner hidden" id="scoreBanner"></div>
      </div>
    </div>
  </section>

  <div id="quiz"></div>

  <section class="card hidden" id="footerCard">
    <div class="footer">
      <div>
        <button class="btn" id="prevBtn">上一題（←）</button>
        <button class="btn" id="confirmBtn">確認（Enter）</button>
        <button class="btn" id="nextBtn">下一題（→）</button>
        <button class="btn review" id="toggleReviewBtn">加入/移出複習清單（5）</button>
      </div>
      <div>
        <button class="btn" id="submitBtn">交卷（列出本次全部題）</button>
        <button class="btn secondary" id="exportReviewBtn">匯出複習清單ID</button>
      </div>
    </div>
  </section>
</main>
<script>
const BANK = [
  {
    "id": 1,
    "question": "In the Security Management Architecture, what port and process SmartConsole uses to communicate with the management server?",
    "choices": [
      "CPM and 18190",
      "FWM and 19009",
      "CPM and 19009",
      "CPM 19009 and 18191"
    ],
    "answer": 2
  },
  {
    "id": 2,
    "question": "The Check Point Watch Daemon (CPWD) monitors critical Check Point processes, terminating them or restarting them as needed to maintain consistent, stable operating conditions. When checking the status/output of CPWD you are able to see some columns like APP, PID, STAT, START, etc. What is the column “STAT” used for?",
    "choices": [
      "Shows the status of the monitored process",
      "Shows how many times the WatchDog started the monitored process",
      "Shows the WatchDog name of the monitored process",
      "Shows what monitoring method WatchDog is using to track the process"
    ],
    "answer": 0
  },
  {
    "id": 3,
    "question": "Which of the following commands can be used to see the list of processes monitored by the Watch Dog process?",
    "choices": [
      "cpstat fw -f watchdog",
      "fw ctl get str watchdog",
      "cpwd_admin list",
      "ps -ef | grep watchd"
    ],
    "answer": 2
  },
  {
    "id": 4,
    "question": "You run cpwd_admin list on a Security Gateway and notice that the CPM process is not listed. Select best answer?",
    "choices": [
      "The output is different between gateway and Management server.",
      "CPM is not running and can’t be monitored by watch dog.",
      "If you want to monitor CPM you have to manually add it to watch dog.",
      "CPM is not there because it has own monitoring system. Only lower processes are monitored by watch dog."
    ],
    "answer": 0
  },
  {
    "id": 5,
    "question": "What process monitors, terminates, and restarts critical Check Point processes as necessary?",
    "choices": [
      "CPM",
      "FWD",
      "CPWD",
      "FWM"
    ],
    "answer": 2
  },
  {
    "id": 6,
    "question": "You found out that $FWDIR/log/fw.log is constantly growing in size at a Security Gateway, what is the reason?",
    "choices": [
      "TCP state logging is enabled",
      "It’s not a problem the gateway is logging connections and also sessions",
      "fw.log can grow when GW does not have space in logging directory",
      "The GW is logging locally"
    ],
    "answer": 3
  },
  {
    "id": 7,
    "question": "What tool would you run to diagnose logging and indexing?",
    "choices": [
      "run cpm_doctor.sh",
      "cpstat mg -f log_server",
      "run diagnostic view",
      "run doctor-log.sh"
    ],
    "answer": 3
  },
  {
    "id": 8,
    "question": "Where will the usermode core files located?",
    "choices": [
      "$FWDIR/var/log/dump/usermode",
      "/var/suroot",
      "/var/log/dump/usermode",
      "$CPDIR/var/log/dump/usermode"
    ],
    "answer": 2
  },
  {
    "id": 9,
    "question": "When a user space process or program suddenly crashes, what type of file is created for analysis?",
    "choices": [
      "core dump",
      "kernel_memory_dump.dbg",
      "core analyzer",
      "coredebug"
    ],
    "answer": 0
  },
  {
    "id": 10,
    "question": "You receive reports from multiple users that they cannot browse. Upon further discovery you identify that Identity Awareness cannot identify the users properly and apply the configured Access Roles. What commands you can use to troubleshoot all identity collectors and identity providers from the command line?",
    "choices": [
      "on the gateway: pdp debug set IDC all IDP all",
      "on the gateway: pdp debug set AD all and IDC all",
      "on the management: pdp debug on IDC all",
      "on the management: pdp debug set all"
    ],
    "answer": 0
  },
  {
    "id": 11,
    "question": "When a User process or program suddenly crashes, a core dump is often used to examine the problem. Which command is used to enable the core-dumping via GAIA clish?",
    "choices": [
      "set core-dump enable",
      "set core-dump total",
      "set user-dump enable",
      "set core-dump per_process"
    ],
    "answer": 0
  },
  {
    "id": 12,
    "question": "What is the best way to resolve an issue caused by a frozen process?",
    "choices": [
      "Power off the machine",
      "Restart the process",
      "Reboot the machine",
      "Kill the process"
    ],
    "answer": 2
  },
  {
    "id": 13,
    "question": "What is NOT monitored as a PNOTE by ClusterXL?",
    "choices": [
      "ted",
      "Policy",
      "RouteD",
      "vpnd"
    ],
    "answer": 3
  },
  {
    "id": 14,
    "question": "What is NOT a benefit of the ‘fw ctl zdebug’ command?",
    "choices": [
      "Automatically allocate a 1MB buffer",
      "Collect debug messages from the kernel",
      "Cannot be used to debug additional modules",
      "Clean the buffer"
    ],
    "answer": 2
  },
  {
    "id": 15,
    "question": "Which command is used to write a kernel debug to a file?",
    "choices": [
      "fw ctl kdebug -T -I > debug.txt",
      "fw ctl debug -S -t > debug.txt",
      "fw ctl kdebug -T -f > debug.txt",
      "fw ctl debut -T -f > debug.txt"
    ],
    "answer": 2
  },
  {
    "id": 16,
    "question": "What is the buffer size set by the fw ctl zdebug command?",
    "choices": [
      "8GB",
      "1 MB",
      "1 GB",
      "8 MB"
    ],
    "answer": 1
  },
  {
    "id": 17,
    "question": "You are seeing output from the previous kernel debug. What command should you use to avoid that?",
    "choices": [
      "fw ctl clean buffer = 0",
      "fw ctl debug 0",
      "fw ctl zdebug disable",
      "fw ctl debug = 0"
    ],
    "answer": 1
  },
  {
    "id": 18,
    "question": "During firewall kernel debug with fw ctl zdebug you received less information that expected. You noticed that a lot of messages were lost since the time the debug was started. What should you do to resolve this issue?",
    "choices": [
      "Increase debug buffer; Use fw ctl debug -buf 32768",
      "Redirect debug output to file; Use fw ctl debug -o ./debug.elg",
      "Redirect debug output to file; Use fw ctl zdebug -o ./debug.elg",
      "Increase debug buffer; Use fw ctl zdebug -buf 32768"
    ],
    "answer": 0
  },
  {
    "id": 19,
    "question": "What is the benefit of fw ctl debug over fw ctl zdebug?",
    "choices": [
      "There is no difference. Both are used for debugging kernel",
      "You don’t need timestamps",
      "It allows you to debug multiple modules at the same time",
      "You only need 1MB buffer"
    ],
    "answer": 2
  },
  {
    "id": 20,
    "question": "The Check Point Firewall Kernel is the core component of the Gaia operating system and an integral part of the traffic inspection process. There are two procedures available for debugging the firewall kernel. Which procedure/command is used for troubleshooting packet drops and other kernel activities while using minimal resources (1 MB buffer)?",
    "choices": [
      "fw ctl zdebug",
      "fwk ctl debug",
      "fw debug ctl",
      "fw ctl debug/kdebug"
    ],
    "answer": 0
  },
  {
    "id": 21,
    "question": "You need to monitor traffic pre-inbound and before the VPN-module in a security gateway. How would you achieve this using fw monitor?",
    "choices": [
      "fw monitor -p all",
      "fw monitor -pi -vpn",
      "fw monitor -pi +vpn",
      "fw monitor -pl +vpn"
    ],
    "answer": 1
  },
  {
    "id": 22,
    "question": "You need to run a kernel debug over a longer period of time as the problem occurs only once or twice a week. Therefore, you need to add a timestamp to the kernel debug and write the output to a file. What is the correct syntax for this?",
    "choices": [
      "fw ctl debug -T -f > filename.debug",
      "fw ctl kdebug -T -f -o filename.debug",
      "fw ctl kdebug -T > filename.debug",
      "fw ctl kdebug -T -f > filename.debug"
    ],
    "answer": 3
  },
  {
    "id": 23,
    "question": "What is the correct syntax to set all debug flags for Unified Policy related issues?",
    "choices": [
      "fw ctl kdebug -m UP all",
      "fw ctl debug -m UP all",
      "fw ctl debug -m up all",
      "fw ctl debug -m fw all"
    ],
    "answer": 1
  },
  {
    "id": 24,
    "question": "What is the shorthand reference for a classification object?",
    "choices": [
      "classobj",
      "CLOB",
      "COBJ",
      "class.obj"
    ],
    "answer": 1
  },
  {
    "id": 25,
    "question": "The Unified Access Control policy eliminates the need to maintain policies for different access control features. However, you need to start a general debug of the Unified Policy with all flags turned on. Which of the following is the correct syntax?",
    "choices": [
      "fw ctl debug -m UP all",
      "fw ctl debug -m UP + all flags",
      "fw ctl kdebug -m UP all",
      "fwm ctl debug -m UP all"
    ],
    "answer": 0
  },
  {
    "id": 26,
    "question": "The FileApp parser in the Content Awareness engine does not extract text from which of the following file types?",
    "choices": [
      "Microsoft Office Excel files",
      "Microsoft Office PowerPoint files",
      "Microsoft Office .docx files",
      "PDF’s"
    ],
    "answer": 3
  },
  {
    "id": 27,
    "question": "In Check Point’s Packet Processing Infrastructure, what is the role of Observers?",
    "choices": [
      "Observers attach object IDs to traffic",
      "They store Rule Base matching state related information",
      "Observers monitor the state of Check Point gateways and report it to the security manager",
      "Observers decide whether or not to publish a CLOB to the Security Policy"
    ],
    "answer": 3
  },
  {
    "id": 28,
    "question": "What is the kernel process for Content Awareness that collects the data from the contexts received from the CMI and decides if the file is matched by a data type?",
    "choices": [
      "cntawmod",
      "cntmgr",
      "dlpda",
      "dlpu"
    ],
    "answer": 0
  },
  {
    "id": 29,
    "question": "The packet processing infrastructure consists of 4 components. Which component contains the CLOB, the object that contains information about the packet that is needed to make security decisions?",
    "choices": [
      "Manager",
      "Classifiers",
      "Handlers",
      "Observers"
    ],
    "answer": 1
  },
  {
    "id": 30,
    "question": "Which of the following is a component of the Context Management Infrastructure used to collect signatures in user space from multiple sources, such as Application Control and IPS, and compiles them together into unified Pattern Matchers?",
    "choices": [
      "Context Loader",
      "PSL - Passive Signature Loader",
      "cpas",
      "CMI Loader"
    ],
    "answer": 3
  },
  {
    "id": 31,
    "question": "Which of these packet processing components stores Rule Base matching state-related information?",
    "choices": [
      "Classifiers",
      "Manager",
      "Handlers",
      "Observers"
    ],
    "answer": 2
  },
  {
    "id": 32,
    "question": "Check Point Access Control Daemons contains several daemons for Software Blades and features. Which Daemon is used for Application & Control URL Filtering?",
    "choices": [
      "pdpd",
      "rad",
      "cprad",
      "pepd"
    ],
    "answer": 1
  },
  {
    "id": 33,
    "question": "What is correct about the Resource Advisor (RAD) service on the Security Gateways?",
    "choices": [
      "RAD is not a separate module, it is an integrated function of the ‘fw’ kernel module and does all operations in the kernel space",
      "RAD functions completely in user space. The Pattern Matcher (PM) module of the CMI looks up for URLs in the cache and if not found, contact the RAD process in user space to do online categorization",
      "RAD is completely loaded as a kernel module that looks up URL in cache and if not found connects online for categorization. There is no user space involvement in this process",
      "RAD has a kernel module that looks up the kernel cache, notifies client about hits and misses and forwards a-sync requests to RAD user space module which is responsible for online categorization"
    ],
    "answer": 3
  },
  {
    "id": 34,
    "question": "When URL category is not found in the kernel cache, what action will GW do?",
    "choices": [
      "RAD in user space will forward request to the cloud",
      "GW will update kernel cache during next policy install",
      "RAD in kernel space will forward request to the cloud",
      "RAD forwards this request to CMI which is the brain of inspection"
    ],
    "answer": 0
  },
  {
    "id": 35,
    "question": "How does Identity Collector connect to Windows Server?",
    "choices": [
      "ADQuery is needed for connection",
      "LDAP connection",
      "It uses a PDP demon to connect",
      "via Windows API"
    ],
    "answer": 3
  },
  {
    "id": 36,
    "question": "Captive Portal, PDP and PEP run in what space?",
    "choices": [
      "User",
      "CPM",
      "FWD",
      "Kernel"
    ],
    "answer": 0
  },
  {
    "id": 37,
    "question": "What are the three main component of Identity Awareness?",
    "choices": [
      "Client, SMS and Secure Gateway",
      "Identity Source, Identity Server (PDP) and Identity Enforcement (PEP)",
      "Identity Awareness Blade on Security Gateway, User Database on Security Management Server and Active Directory",
      "User, Active Directory and Access Role"
    ],
    "answer": 1
  },
  {
    "id": 38,
    "question": "What cli command is run on the GW to verify communication to the Identity Collector?",
    "choices": [
      "pdp connections idc",
      "pep connections idc",
      "show idc connections",
      "fwd connected"
    ],
    "answer": 0
  },
  {
    "id": 39,
    "question": "What function receives the AD log event information?",
    "choices": [
      "FWD",
      "CPD",
      "PEP",
      "ADLOG"
    ],
    "answer": 3
  },
  {
    "id": 40,
    "question": "You receive complains that Guest Users cannot login and use the Guest Network which is configured with Access Role of Guest Users. You need to verify the Captive Portal configuration. Where can you find the config file?",
    "choices": [
      "on the gateway at $NACPORTAL_HOME/conf/httpd_nac.conf",
      "on the management at $CPNAC_HOME/conf/httpd_nac.conf",
      "on the management at $NACPORTAL_HOME/conf/httpd_nac.conf",
      "on the gateway at $CPNAC_HOME/conf/httpd_nac.conf"
    ],
    "answer": 0
  },
  {
    "id": 41,
    "question": "What command would you run to verify the communication between the Security Gateway and the Identity Collector?",
    "choices": [
      "fw ctl debug -m IDAPI",
      "pdp connections idc",
      "fw ctl debug -m fw + nac",
      "adlog"
    ],
    "answer": 1
  },
  {
    "id": 42,
    "question": "You are using the Identity Collector with Identity Awareness in large environment. Users report that they cannot access resources on Internet. You identify that the traffic is matching the cleanup rule instead of the proper rule with Access Roles using the IDC. How can you check if IDC is working?",
    "choices": [
      "pdp connections idc",
      "ad query | debug on",
      "pep debug idc on",
      "pdp debug set IDP all"
    ],
    "answer": 0
  },
  {
    "id": 43,
    "question": "For Identity Awareness, what is the PDP process?",
    "choices": [
      "Identity server",
      "Captive Portal Service",
      "User Auth Database",
      "Log Sifter"
    ],
    "answer": 0
  },
  {
    "id": 44,
    "question": "What is the correct syntax to turn a VPN debug on and create new empty debug files?",
    "choices": [
      "vpndebug trunc on",
      "vpn debug truncon",
      "vpn debug trunkon",
      "vpn kdebug on"
    ],
    "answer": 1
  },
  {
    "id": 45,
    "question": "How many packets are needed to establish IKEv1?",
    "choices": [
      "Only three packets for main mode",
      "8",
      "5",
      "6"
    ],
    "answer": 3
  },
  {
    "id": 46,
    "question": "You want to fully investigate the VPN establishment, what will you do?",
    "choices": [
      "vpn debug and use IKEview",
      "debug FWD because VPND is child process",
      "use vpn tu command and use option 8 to start debug",
      "use kernel debug with fw ctl debug -m VPN all"
    ],
    "answer": 0
  },
  {
    "id": 47,
    "question": "Your users have some issues connecting with Mobile Access VPN to your gateway. How can you debug the tunnel establishment?",
    "choices": [
      "run vpn debug truncon",
      "in the file $VPNDIR/conf/httpd.conf change the line LogLevel to LogLevel debug and run vpn restart",
      "in the file $CVPNDIR/conf/httpd.conf change the line LogLevel to LogLevel debug and run cvpn restart",
      "run fw ctl zdebug -m sslvpn all"
    ],
    "answer": 2
  },
  {
    "id": 48,
    "question": "VPN’s allow traffic to pass through the Internet securely by encrypting the traffic as it enters the VPN tunnel and then decrypting the traffic as it exists. Which process is responsible for Mobile VPN connections?",
    "choices": [
      "cvpnd",
      "fwk",
      "vpnd",
      "vpnk"
    ],
    "answer": 0
  },
  {
    "id": 49,
    "question": "What command(s) will turn off all vpn debug collection?",
    "choices": [
      "vpn debug -a off",
      "fw ctl debug 0",
      "vpn debug off",
      "vpn debug off and vpn debug ikeoff"
    ],
    "answer": 3
  },
  {
    "id": 50,
    "question": "Troubleshooting issues with Mobile Access requires the following:",
    "choices": [
      "‘ma_vpnd’ process on Security Gateway",
      "Debug logs of FWD captured with the command - ‘fw debug fwd on TDERROR_MOBILE_ACCESS=5’",
      "Standard VPN debugs, packet captures, and debugs of ‘cvpnd’ process on Security Gateway",
      "Standard VPN debugs and packet captures on Security Gateway, debugs of ‘cvpnd’ process on Security Management"
    ],
    "answer": 2
  },
  {
    "id": 51,
    "question": "What is the most efficient way to read an IKEv2 Debug?",
    "choices": [
      "IKEview",
      "vi on the cli",
      "notepad++",
      "any xml editor"
    ],
    "answer": 0
  },
  {
    "id": 52,
    "question": "You were asked by security team to debug Mobile Access VPN. What processes will you debug?",
    "choices": [
      "HTTPD and CPVND",
      "IKED",
      "VPND and IKED",
      "SNX daemon"
    ],
    "answer": 0
  },
  {
    "id": 53,
    "question": "Like a Site-to-Site VPN between two Security Gateways, a Remote Access VPN relies on the Internet Key Exchange (IKE), what types of keys are generated by IKE during negotiation?",
    "choices": [
      "Produce a symmetric key on both sides",
      "Produce an asymmetric key on both sides",
      "Symmetric keys based on pre-shared secret",
      "Produce a pair of public and private keys"
    ],
    "answer": 0
  },
  {
    "id": 54,
    "question": "User defined URLs and HTTPS Inspection User defined URLs on the Security Gateway are stored in which database file?",
    "choices": [
      "https_urlf.bin",
      "urlf_db.bin",
      "urlf_https.bin",
      "https_db.bin"
    ],
    "answer": 1
  },
  {
    "id": 55,
    "question": "After kernel debug with “fw ctl debug” you received a huge amount of information. It was saved in a very large file that is difficult to open and analyze with standard text editors. Suggest a solution to solve this issue.",
    "choices": [
      "Reduce debug buffer to 1024KB and run debug for several times",
      "Use Check Point InfoView utility to analyze debug output",
      "Use “fw ctl zdebug” because of 1024KB buffer size",
      "Divide debug information into smaller files. Use “fw ctl kdebug -f -o “filename” -m 25 -s “1024”"
    ],
    "answer": 1
  },
  {
    "id": 56,
    "question": "What command is used to find out which port Multi-Portal has assigned to the Mobile Access Portal?",
    "choices": [
      "mpclient getdata sslvpn",
      "netstat -nap | grep mobile",
      "netstat getdata sslvpn",
      "mpclient getdata mobi"
    ],
    "answer": 0
  },
  {
    "id": 57,
    "question": "Which of the following daemons is used for Threat Extraction?",
    "choices": [
      "extractd",
      "tedex",
      "tex",
      "scrubd"
    ],
    "answer": 3
  },
  {
    "id": 58,
    "question": "You modified kernel parameters and after rebooting the gateway, a lot of production traffic gets dropped and the gateway acts strangely. What should you do?",
    "choices": [
      "Run command fw ctl set int fw1_kernel_all_disable=1",
      "Restore fwkern.conf from backup and reboot the gateway",
      "run fw unloadlocal to remove parameters from kernel",
      "Remove all kernel parameters from fwkern.conf and reboot"
    ],
    "answer": 1
  },
  {
    "id": 59,
    "question": "You run a free-command on a gateway and notice that the Swap column is not zero. Choose the best answer.",
    "choices": [
      "Utilization of ram is high and swap file had to be used.",
      "Swap file is used regularly because RAM memory is reserved for management traffic.",
      "Swap memory is used for heavy connections when RAM memory is full.",
      "Its ok. Swap is used to increase performance."
    ],
    "answer": 0
  },
  {
    "id": 60,
    "question": "When dealing with monolithic operating systems such as Gaia, where are system calls initiated from to achieve a required system level function?",
    "choices": [
      "Kernel Mode",
      "Slow Path",
      "Medium Path",
      "User Mode"
    ],
    "answer": 3
  },
  {
    "id": 61,
    "question": "Which of the following file is commonly associated with troubleshooting crashes on a system such as the Security Gateway?",
    "choices": [
      "tcpdump",
      "core dump",
      "fw monitor",
      "CPMIL dump"
    ],
    "answer": 1
  },
  {
    "id": 62,
    "question": "Your fwm constantly crashes and is restarted by the watchdog. You can’t find any coredumps related to this process, so you need to check if coredumps are enabled at all. How can you achieve that?",
    "choices": [
      "in clish run show core-dump status",
      "in clish run set core-dump status",
      "in expert mode run show core-dump status",
      "in clish run show coredumb status"
    ],
    "answer": 0
  },
  {
    "id": 63,
    "question": "What command is usually used for general firewall kernel debugging and what is the size of the buffer that is automatically enabled when using the command?",
    "choices": [
      "fw ctl debug, buffer size is 1024 KB",
      "fw ctl zdebug, buffer size is 1 MB",
      "fw ctl kdebug, buffer size is 32000 KB",
      "fw ctl zdebug, buffer size is 32768 KB"
    ],
    "answer": 1
  },
  {
    "id": 64,
    "question": "When debugging is enabled on firewall kernel module using the ‘fw ctl debug’ command with required options, many debug messages are provided by the kernel that help the administrator to identify issues. Which of the following is true about these debug messages generated by the kernel module?",
    "choices": [
      "Messages are written to /etc/dmesg file",
      "Messages are written to a buffer and collected using ‘fw ctl kdebug’",
      "Messages are written to $FWDIR/log/fw.elg",
      "Messages are written to console and also /var/log/messages file"
    ],
    "answer": 1
  },
  {
    "id": 65,
    "question": "RAD is initiated when Application Control and URL Filtering blades are active on the Security Gateway. What is the purpose of the following RAD configuration file $FWDIR/conf/rad_settings.C?",
    "choices": [
      "This file contains the location information for Application Control and/or URL Filtering entitlements",
      "This file contains the information on how the Security Gateway reaches the Security Managers RAD service for Application Control and URL Filtering",
      "This file contains RAD proxy settings",
      "This file contains all the host name settings for the online application detection engine"
    ],
    "answer": 1
  },
  {
    "id": 66,
    "question": "Which two files contain the Application Database on the Security Gateway?",
    "choices": [
      "api_db.C and api_custom_db.C",
      "apcl_db.C and apcl_custom_db.C",
      "application_db.C and application_custom_db.C",
      "appi_db.C and appi_custom_db.C"
    ],
    "answer": 3
  },
  {
    "id": 67,
    "question": "How can you start debug of the Unified Policy with all possible tags turned on?",
    "choices": [
      "fw ctl debug -m fw + UP",
      "fw ctl debug -m UP all",
      "fw ctl debug -m UP *",
      "fw ctl debug -m UnifiedPolicy all"
    ],
    "answer": 1
  },
  {
    "id": 68,
    "question": "URL Filtering is an essential part of Web Security in the Gateway. For the Security Gateway to perform a URL lookup when a client makes a URL request, where is the sync-request forwarded from if a sync-request is required?",
    "choices": [
      "URLF Kernel Client",
      "RAD User Space",
      "RAD Kernel Space",
      "URLF Online Service"
    ],
    "answer": 1
  },
  {
    "id": 69,
    "question": "What file contains the RAD proxy settings?",
    "choices": [
      "rad_control.C",
      "rad_scheme.C",
      "rad_services.C",
      "rad_settings.C"
    ],
    "answer": 3
  },
  {
    "id": 70,
    "question": "What is the Security Gateway directory where an administrator can find vpn debug log files generated during Site-to-Site VPN troubleshooting?",
    "choices": [
      "$FWDIR/conf/",
      "$CPDIR/conf/",
      "$FWDIR/log/",
      "/opt/CPsuiteR80/vpn/log/"
    ],
    "answer": 2
  },
  {
    "id": 71,
    "question": "In Mobile Access VPN, clientless access is done using a web browser. The primary communication path for these browser based connections is a process that allows numerous processes to utilize port 443 and redirects traffic to a designated port of the respective process. Which daemon handles this?",
    "choices": [
      "Multi-portal Daemon (MPD)",
      "Mobile Access Daemon (MAD)",
      "HTTPS Inspection Daemon (HID)",
      "Connectra VPN Daemon (cvpnd)"
    ],
    "answer": 0
  },
  {
    "id": 72,
    "question": "What is the name of the VPN kernel process?",
    "choices": [
      "VPND",
      "CVPND",
      "FWK",
      "VPNK"
    ],
    "answer": 3
  },
  {
    "id": 73,
    "question": "What component is NOT part of Unified policy manager?",
    "choices": [
      "Classifier",
      "CMI",
      "Handle",
      "Observer"
    ],
    "answer": 1
  },
  {
    "id": 74,
    "question": "What is the function of the Core Dump Manager utility?",
    "choices": [
      "To determine which process is slowing down the system",
      "To send crash information to an external analyzer",
      "To limit the number of core dump files per process as well as the total amount of disk space used by core files",
      "To generate a new core dump for analysis"
    ],
    "answer": 2
  },
  {
    "id": 75,
    "question": "When a User Mode process suddenly crashes, it may create a core dump file. Which of the following information is available in the core dump and may be used to identify the root cause of the crash? i. Program Counter ii. Stack Pointer iii. Memory management information iv. Other Processor and OS flags / information",
    "choices": [
      "iii and iv only",
      "i and ii only",
      "i, ii, iii and iv",
      "Only iii"
    ],
    "answer": 2
  },
  {
    "id": 76,
    "question": "You need to run a kernel debug over a longer period of time as the problem occurs only once or twice a week. Therefore, you need to add a timestamp to the kernel debug and write the output to a file but you can’t afford to fill up all the remaining disk space and you only have 10 GB free for saving the debugs. What is the correct syntax for this?",
    "choices": [
      "fw ctl kdebug -T -f -m 10 -s 1000000 -o debugfilename",
      "fw ctl debug -T -f -m 10 -s 1000000 -o debugfilename",
      "fw ctl kdebug -T -f -m 10 -s 1000000 > debugfilename",
      "fw ctl kdebug -T -m 10 -s 1000000 -o debugfilename"
    ],
    "answer": 0
  },
  {
    "id": 77,
    "question": "The Check Point Firewall Kernel is the core component of the Gaia operating system and an integral part of traffic inspection process. There are two procedures available for debugging the firewall kernel. Which procedure/command is used for detailed troubleshooting and needs more resources?",
    "choices": [
      "fw ctl zdebug",
      "fw debug/kdebug",
      "fw ctl debug/kdebug",
      "fw debug/kdebug ctl"
    ],
    "answer": 2
  },
  {
    "id": 78,
    "question": "What is the simplest and most efficient way to check all dropped packets in real time?",
    "choices": [
      "fw ctl zdebug + drop in expert mode",
      "Smartlog",
      "cat /dev/fw1/log in expert mode",
      "tail -f $FWDIR/log/fw.log |grep drop in expert mode"
    ],
    "answer": 0
  },
  {
    "id": 79,
    "question": "Which of the following would NOT be a tag when debugging a unified policy?",
    "choices": [
      "tls",
      "rulebase",
      "clob",
      "connection"
    ],
    "answer": 0
  },
  {
    "id": 80,
    "question": "What components make up the Context Management Infrastructure?",
    "choices": [
      "CPMI and FW Loader",
      "CPX and FWM",
      "CPM and SOLR",
      "CMI Loader and Pattern Matcher"
    ],
    "answer": 3
  },
  {
    "id": 81,
    "question": "Which of the following inputs is available for debugging HTTPS inspection issues?",
    "choices": [
      "run debug optic on",
      "fw ctl debug -m fw + conn http_inspect",
      "fw ctl debug -m fw + comr http optic",
      "fw ctl debug -m http enable"
    ],
    "answer": 1
  },
  {
    "id": 82,
    "question": "Which Daemon should be debugged for HTTPS inspection related issues?",
    "choices": [
      "VPAD",
      "HSTLSD",
      "PWD",
      "HTTPD"
    ],
    "answer": 1
  },
  {
    "id": 83,
    "question": "What does CMI stand for in relation to the Access Control Policy?",
    "choices": [
      "Context Manipulation Interface",
      "Content Management Infrastructure",
      "Content Management Interface",
      "Content Matching Infrastructure"
    ],
    "answer": 1
  },
  {
    "id": 84,
    "question": "VPN issues may result from misconfiguration, communication failure, or incompatible default configuration between peers. Which basic command syntax needs to be used for troubleshooting Site-to-Site VPN issues?",
    "choices": [
      "vpn debug on",
      "cp debug vpncon",
      "vpn debug ikeon",
      "run debug vpncon"
    ],
    "answer": 2
  },
  {
    "id": 85,
    "question": "You receive reports that Users cannot browse internet sites. You are using identity awareness with AD Query and Identity Collector in addition you have the Browser Based Authentication Enabled. What command can be used to debug the problem?",
    "choices": [
      "on the gateway: ad debug on",
      "on the gateway: ad query debug on",
      "on the management: ad query debug extended",
      "on the gateway: pdp debug nac extended"
    ],
    "answer": 3
  },
  {
    "id": 86,
    "question": "If the cpsend process of SmartEvent has crashed or is having trouble coming up, then it usually indicates that ______.",
    "choices": [
      "The SmartEvent core on the Solr indexer has been deleted",
      "The logged in administrator does not have permissions to run SmartEvent",
      "Postgres database is down",
      "Cpd daemon is unable to connect to the log server"
    ],
    "answer": 2
  },
  {
    "id": 87,
    "question": "Which command can be used to see the list of processes monitored by the Watch Dog process?",
    "choices": [
      "cpstat fw -f watchdog",
      "fw ctl get str watchdog",
      "cpwd_admin list",
      "ps -ef | grep watchd"
    ],
    "answer": 2
  },
  {
    "id": 88,
    "question": "Your users are having trouble opening a Web page and you need to troubleshoot it. You open the Smart Console, and you get the following message when you navigate to the Logs and Monitor \"SmartLog is not active or Failed to parse results from server\". What is the first thing you can try to resolve it?",
    "choices": [
      "Run the commands on the SMS: smartlogstart and smartlogstop",
      "smartlog debug on and smartlog debug off",
      "smartlog_server restart",
      "cpmstop and cpmstart"
    ],
    "answer": 2
  },
  {
    "id": 89,
    "question": "PostgreSQL is a powerful, open source relational database management system. Check Point offers a command for viewing the database to interact with Postgres interactive shell. Which command do you need to enter the PostgreSQL interactive shell?",
    "choices": [
      "mysql_client cpm postgres",
      "mysql -u root",
      "psql_client cpm postgres",
      "psql_client postgres cpm"
    ],
    "answer": 2
  },
  {
    "id": 90,
    "question": "What version of Check Point can Security Gateways begin dynamically distributing Logs between log servers?",
    "choices": [
      "R81",
      "R77",
      "R30",
      "R75"
    ],
    "answer": 0
  },
  {
    "id": 91,
    "question": "Check Point provides tools & commands to help you to identify issues about products and applications. Which Check Point command can help you to display status and statistics information for various Check Point products and applications?",
    "choices": [
      "CPview",
      "cpstat",
      "fwvstat",
      "CPstat"
    ],
    "answer": 1
  },
  {
    "id": 92,
    "question": "In some scenarios it is very helpful to use advanced Linux commands for troubleshooting purposes. Which command displays information about resource utilization for running processes and shows additional information for core utilization and memory?",
    "choices": [
      "top",
      "vmstat",
      "cptop",
      "mpstat"
    ],
    "answer": 0
  },
  {
    "id": 93,
    "question": "What is the purpose of the Global Domain?",
    "choices": [
      "Global Domains is used by the IPS software blade to map the IDs to the corresponding countries according to the IpToCountry.csv file.",
      "This domain is used as the global database to back up the objects referencing the corresponding object attributes from the System Domain.",
      "This domain is used as the global database to track the changes made by multiple administrators on the same objects prior to publishing.",
      "This domain is used as the global database for MDSM and contains global objects and policies."
    ],
    "answer": 3
  },
  {
    "id": 94,
    "question": "Which process is responsible for the generation of certificates?",
    "choices": [
      "dbsync",
      "cpm",
      "fwm",
      "cpca"
    ],
    "answer": 3
  },
  {
    "id": 95,
    "question": "If SmartLog is not active or failed to parse results from server, what commands can be run to re-enable the service?",
    "choices": [
      "smartlogrestart and smartlogstart",
      "smartlogstart and smartlogstop",
      "smartloginit and smartlogstop",
      "smartlogstart and smartlogsetup"
    ],
    "answer": 0
  },
  {
    "id": 96,
    "question": "John has renewed his NPTX License but he gets an error (contract for Anti-Bot expired). He wants to check the subscription status on the CLI of the gateway, what command can he use for this?",
    "choices": [
      "fwm lie print",
      "fw monitor license status",
      "cpstat antimalware -f subscription status",
      "show license status"
    ],
    "answer": 3
  },
  {
    "id": 97,
    "question": "What are the main components of Check Point’s Security Management architecture?",
    "choices": [
      "Management server, Log server, Gateway server, Security server",
      "Management server, management database, log server, automation server",
      "Management server, Security Gateway, Multi-Domain Server, SmartEvent Server",
      "Management server, Log Server, LDAP Server, Web Server"
    ],
    "answer": 1
  },
  {
    "id": 98,
    "question": "Where do you enable log indexing on the SMS?",
    "choices": [
      "SMS object under \"Other\"",
      "SMS object under \"Advanced\"",
      "SMS object under \"Logs\"",
      "SMS object under \"General Properties\""
    ],
    "answer": 2
  },
  {
    "id": 99,
    "question": "Which of the following is contained in the System Domain of the Postgres database?",
    "choices": [
      "Trusted GUI clients",
      "Configuration data of log servers",
      "Saved queries for applications",
      "User modified configurations such as network objects"
    ],
    "answer": 0
  },
  {
    "id": 100,
    "question": "What are the four main database domains?",
    "choices": [
      "Local, Global, User, VPN",
      "System, Global, Log, Event",
      "System, User, Global, Log",
      "System, User, Host, Network"
    ],
    "answer": 2
  },
  {
    "id": 101,
    "question": "When viewing data for CPMI objects in the Postgres database, what table column should be selected to query for the object instance?",
    "choices": [
      "CpmiHostCkp",
      "fwset",
      "CPM Global M",
      "GuiDBedit"
    ],
    "answer": 0
  },
  {
    "id": 102,
    "question": "What information does the doctor-log script supply?",
    "choices": [
      "Logging errors, Exceptions, Repair options",
      "Current and daily average logging rates, Indexing status, Size",
      "Logging rates, Logging Directories, List of troubleshooting tips",
      "Repair options, Logging Rates, Logging Directories"
    ],
    "answer": 1
  },
  {
    "id": 103,
    "question": "You do not see logs in the SMS. When you login on the SMS shell and run cpwd_admin list you notice that the RFL process is with status T. What command can you run to try to resolve it?",
    "choices": [
      "RFLstop and RFLstart",
      "evstart and evstop",
      "smartlog_server stop and smartlog_server restart",
      "rflstop and rflstart"
    ],
    "answer": 2
  },
  {
    "id": 104,
    "question": "SmartEvent utilizes the Log Server, Correlation Unit and SmartEvent Server to aggregate logs and identify security events. The three main processes that govern these SmartEvent components are:",
    "choices": [
      "cpcu, cplog, cpse",
      "eventiasv, eventiarp, eventiacu",
      "cpsemd, cpsead, and DBSync",
      "fwd, secu, sesrv"
    ],
    "answer": 2
  },
  {
    "id": 105,
    "question": "An administrator receives reports about issues with log indexing and text searching regarding an existing Management Server. In trying to find a solution she wants to check if the process responsible for this feature is running correctly. What is true about the related process?",
    "choices": [
      "cpd needs to be restarted manual to show in the list",
      "fwm manages this database after initialization of the ICA",
      "solr is a child process of cpm",
      "fwssd crashes can affect therefore not show in the list"
    ],
    "answer": 2
  }
];

const el = (sel)=>document.querySelector(sel);
const quizEl = el('#quiz');
const scoreBanner = el('#scoreBanner');
const modeEl = el('#mode');
const countEl = el('#count');
const toggleReviewBtn = el('#toggleReviewBtn');
const confirmBtn = el('#confirmBtn');
const nextBtn = el('#nextBtn');
const prevBtn = el('#prevBtn');
const footerCard = el('#footerCard');
const rangeFromEl = el('#rangeFrom');
const rangeToEl = el('#rangeTo');
const searchWrap = el('#searchWrap');
const searchInput = el('#searchInput');
const searchBtn = el('#searchBtn');
const clearSearchBtn = el('#clearSearchBtn');
const countWrap = el('#countWrap');
const rangeWrap = el('#rangeWrap');
const toggleOriginal = el('#toggleOriginal');

let started = false;
let order = [];
let answers = {};
let revealed = {};
let locked = {};
let idx = 0;

const OLD_WRONG_KEY = "ccse_wrong_ids";
const OLD_MARK_KEY  = "ccse_mark_ids";
const REVIEW_KEY    = "ccse_review_ids";
const STATS_KEY     = "ccse_stats";
const SHOW_ORIG_KEY = "ccse_show_orig";
(function migrate(){
  try {
    const existing = JSON.parse(localStorage.getItem(REVIEW_KEY) || "[]");
    if (!existing || existing.length === 0){
      const oldWrong = JSON.parse(localStorage.getItem(OLD_WRONG_KEY) || "[]");
      const oldMark  = JSON.parse(localStorage.getItem(OLD_MARK_KEY)  || "[]");
      const merged = Array.from(new Set([...(oldWrong||[]), ...(oldMark||[])]));
      if (merged.length){
        localStorage.setItem(REVIEW_KEY, JSON.stringify(merged));
      }
    }
  } catch(e){}
})();
const reviewSet = new Set(JSON.parse(localStorage.getItem(REVIEW_KEY) || "[]"));
let stats = {};
try { stats = JSON.parse(localStorage.getItem(STATS_KEY) || "{}"); } catch(e){ stats = {}; }
try { toggleOriginal.checked = JSON.parse(localStorage.getItem(SHOW_ORIG_KEY) || "false"); } catch(e){}

function updateHdr(){
  el('#hdrMeta').textContent = `題庫：${BANK.length} 題｜複習清單：${reviewSet.size}`;
  const mode = modeEl.value;
  footerCard.classList.toggle('hidden', !started || mode==='review_list_all' || mode==='search');
  countWrap.classList.toggle('hidden', !(mode==='exam' || mode==='review_list'));
  rangeWrap.classList.toggle('hidden', !(mode==='exam' || mode==='review_list'));
  searchWrap.classList.toggle('hidden', mode!=='search');
  scoreBanner.classList.add('hidden');
}

function persist(){
  localStorage.setItem(REVIEW_KEY, JSON.stringify(Array.from(reviewSet)));
  localStorage.setItem(STATS_KEY, JSON.stringify(stats));
  localStorage.setItem(SHOW_ORIG_KEY, JSON.stringify(toggleOriginal.checked));
  updateHdr();
}

function applyRange(pool){
  const fromV = parseInt(rangeFromEl.value||"");
  const toV = parseInt(rangeToEl.value||"");
  if(!isNaN(fromV) && !isNaN(toV)){
    const lo = Math.min(fromV, toV);
    const hi = Math.max(fromV, toV);
    return pool.filter(q => (q.id||0) >= lo && (q.id||0) <= hi);
  }
  return pool;
}

function buildQStats(qid){
  const s = stats[qid] || {attempts:0, correct:0, wrong:0};
  return `<span class="qstats">【作答次數: ${s.attempts}｜答對: ${s.correct}｜答錯: ${s.wrong}】</span>`;
}

function cleanQuestion(text){
  const re = /^\s*(question\s*#?\s*\d+\s*[:.)-]?\s*)/i;
  return text.replace(re, '');
}

function computeBasePool(){
  let base = [];
  if (modeEl.value === 'review_list' || modeEl.value === 'review_list_all') {
    base = BANK.filter(q=>reviewSet.has(q.id));
  } else {
    base = BANK.slice();
  }
  if (modeEl.value !== 'review_list_all' && modeEl.value !== 'search') base = applyRange(base);
  return base;
}

function showPreStartSummary(){
  const mode = modeEl.value;
  const n = parseInt(countEl.value,10);
  const base = computeBasePool();
  const poolSize = base.length;
  const fromV = rangeFromEl.value ? parseInt(rangeFromEl.value) : null;
  const toV = rangeToEl.value ? parseInt(rangeToEl.value) : null;
  const rangeTxt = (fromV && toV) ? `${Math.min(fromV,toV)}–${Math.max(fromV,toV)}` : '全部';
  const willUse = (mode==='exam' || mode==='review_list') ? Math.min(n, poolSize) : poolSize;

  const modeLabel = {exam:'Exam（考試模式）', review_list:'Review List（隨機）', review_list_all:'Review List（全部）', search:'Search'}[mode];

  const lines = [
    `<div>模式：<b>${modeLabel}</b></div>`,
    (mode==='search') ? `<div>說明：本模式需輸入關鍵字後按「搜尋」。</div>` : '',
    (mode!=='search' && mode!=='review_list_all') ? `<div>題號範圍：<b>${rangeTxt}</b></div>` : '',
    `<div>可用題數：<b>${poolSize}</b></div>`,
    (mode==='exam' || mode==='review_list') ? `<div>本次題數：<b>${willUse}</b></div>` : '',
  ].join('');

  quizEl.innerHTML = `
    <div class="card">
      <div class="summary">
        <div style="font-weight:600;">開始前摘要</div>
        ${lines}
        <div style="margin-top:8px; display:flex; gap:8px;">
          <button class="btn" id="confirmStartBtn">確認開始</button>
          <button class="btn secondary" id="cancelStartBtn">取消</button>
        </div>
      </div>
    </div>`;

  el('#confirmStartBtn').addEventListener('click', ()=>{
    started = true;
    startActual();
  });
  el('#cancelStartBtn').addEventListener('click', ()=>{
    started = false;
    render();
  });
}

function start(){ started = false; showPreStartSummary(); }

function startActual(){
  answers = {}; revealed = {}; locked = {}; idx = 0;
  scoreBanner.classList.add('hidden');

  const base = computeBasePool();

  if (modeEl.value === 'review_list_all' || modeEl.value === 'search') {
    order = base.slice().sort((a,b)=> (a.id||0)-(b.id||0));
    started = true;
    render();
  } else {
    const n = parseInt(countEl.value,10);
    order = base.slice();
    order = order.sort(()=>Math.random()-0.5).slice(0, Math.min(n, order.length)).map(q => ({...q}));
    if (modeEl.value === 'exam'){
      order = order.map(q => {
        const idxs = [0,1,2,3];
        idxs.sort(()=>Math.random()-0.5);
        const newChoices = idxs.map(i => q.choices[i]);
        const newAnswer = idxs.indexOf(q.answer);
        return {...q, choices:newChoices, answer:newAnswer};
      });
    }
    started = true;
    render();
  }
}

function onPick(i, choice){
  if (!started) return;
  if (locked[i]) return;
  answers[i] = choice;
  render();
}

function confirmCurrent(){
  if (!started) return;
  const q = order[idx];
  if (!q) return;
  if (revealed[idx]) return;
  const a = answers[idx];
  if (a === undefined) return;
  revealed[idx] = true;
  locked[idx] = true;
  if (!stats[q.id]) stats[q.id] = {attempts:0, correct:0, wrong:0};
  stats[q.id].attempts += 1;
  const outcome = (a === q.answer) ? 'correct' : 'wrong';
  stats[q.id][outcome] += 1;
  if (outcome === 'wrong') reviewSet.add(q.id);
  persist();
  render();
}

function goNext(){ if (started && revealed[idx] && idx < order.length - 1){ idx += 1; render(); } }
function goPrev(){ if (started && idx > 0){ idx -= 1; render(); } }

function render(){
  const mode = modeEl.value;
  updateHdr();
  if (!started){
    quizEl.innerHTML = `<div class="card"><div class="qtxt">按「開始」後會先顯示本次小測驗摘要。</div></div>`;
    return;
  }
  if (mode === 'review_list_all'){
    if(order.length===0){
      quizEl.innerHTML = `<div class="card"><div class="qtxt">目前「複習清單」是空的。</div></div>`;
      return;
    }
    quizEl.innerHTML = order.map((q,i)=> renderListCard(q, i, order.length)).join("");
    wireListControls();
    return;
  }
  if (mode === 'search'){
    const query = searchInput.value.trim();
    if(!query){
      quizEl.innerHTML = `<div class="card"><div class="qtxt">請輸入關鍵字再按「搜尋」。支援多關鍵字（以空白分隔）。</div></div>`;
      return;
    }
    const toks = query.split(/\s+/).map(s=>s.toLowerCase());
    const matches = order.filter(q=> toks.every(t=> (q.question+" "+q.choices.join(" ")).toLowerCase().includes(t)));
    if (matches.length===0){
      quizEl.innerHTML = `<div class="card"><div class="qtxt">沒有符合的題目。</div></div>`;
      return;
    }
    quizEl.innerHTML = matches.map((q,i)=> renderListCard(q, i, matches.length)).join("");
    wireListControls();
    return;
  }
  const q = order[idx];
  if(!q){
    quizEl.innerHTML = `<div class="card"><div class="qtxt">沒有符合條件的題目。請調整題號範圍或切換模式。</div></div>`;
    return;
  }
  const a = answers[idx];
  const isRevealed = !!revealed[idx];
  const isLocked = !!locked[idx];
  const choiceHTML = q.choices.map((c,k)=>{
    const chosen = (a === k);
    let cls = "choice";
    if (isLocked) cls += " locked";
    if (chosen) cls += " selected";
    if (isRevealed){
      if (k === q.answer) cls += " correct";
      if (chosen && k !== q.answer) cls += " wrong";
    }
    return `<div class="${cls}" data-k="${k}"><b>${(k+1)}</b>. ${c.replace(/</g,"&lt;")}</div>`;
  }).join("");
  const origIdHtml = toggleOriginal.checked ? `<div class="pill">原始ID #${q.id}</div>` : "";
  const cleaned = cleanQuestion(q.question).replace(/</g,"&lt;");
  quizEl.innerHTML = `
    <div class="card">
      <div class="qhead">
        <div class="qid">題目 ${idx+1} / ${order.length}</div>
        ${origIdHtml}
      </div>
      <div class="qstats">${buildQStats(q.id)}</div>
      <div class="qtxt">${cleaned}</div>
      <div class="choices">${choiceHTML}</div>
    </div>`;
  quizEl.querySelectorAll('.choice').forEach(ch=>{
    ch.addEventListener('click', ()=>{
      const k = parseInt(ch.dataset.k);
      onPick(idx, k);
    });
  });
  prevBtn.classList.toggle('disabled', idx===0);
  nextBtn.classList.toggle('disabled', idx===order.length-1 || !isRevealed);
  confirmBtn.classList.toggle('disabled', isRevealed || a===undefined);
  const inReview = reviewSet.has(q.id);
  toggleReviewBtn.classList.toggle('active', inReview);
  toggleReviewBtn.textContent = inReview ? '已在複習清單（5）' : '加入/移出複習清單（5）';
  try{ confirmBtn.blur(); nextBtn.blur(); prevBtn.blur(); toggleReviewBtn.blur(); }catch(e){}
}

function renderListCard(q, i, total){
  const s = stats[q.id] || {attempts:0, correct:0, wrong:0};
  const choices = q.choices.map((c,k)=>{
    const isCorrect = (k===q.answer);
    const cls = "choice" + (isCorrect ? " correct":"");
    return `<div class="${cls}"><b>${(k+1)}</b>. ${c.replace(/</g,"&lt;")}</div>`;
  }).join("");
  const origIdHtml = toggleOriginal.checked ? `<div class="pill">原始ID #${q.id}</div>` : "";
  const cleaned = cleanQuestion(q.question).replace(/</g,"&lt;");
  return `
  <div class="card" data-qid="${q.id}">
    <div class="qhead">
      <div class="qid">題目 ${i+1} / ${total}</div>
      ${origIdHtml}
    </div>
    <div class="qstats">【作答次數: ${s.attempts}｜答對: ${s.correct}｜答錯: ${s.wrong}】</div>
    <div class="qtxt">${cleaned}</div>
    <div class="choices">${choices}</div>
    <div class="inline-controls" style="margin-top:10px;">
      <button class="btn danger" data-action="removeReview">移出複習清單</button>
    </div>
  </div>`;
}

function wireListControls(){
  quizEl.querySelectorAll('.card').forEach(card=>{
    const qid = parseInt(card.dataset.qid,10);
    const removeBtn = card.querySelector('[data-action="removeReview"]');
    if(removeBtn){
      removeBtn.addEventListener('click', ()=>{
        reviewSet.delete(qid);
        persist();
        card.remove();
      });
    }
  });
}

function submit(){
  if (!started) return;
  const total = order.length;
  let correct = 0;
  const results = [];
  order.forEach((q,i)=>{
    const a = answers[i];
    const ok = (a === q.answer);
    if (ok) correct += 1;
    if (!ok) reviewSet.add(q.id);
    results.push({q, a, ok});
  });
  persist();
  scoreBanner.textContent = `本次成績：${correct}/${total}（${(correct/total*100).toFixed(1)}%）`;
  scoreBanner.classList.remove('hidden');

  quizEl.innerHTML = results.map(({q,a,ok},i)=>{
    const s = stats[q.id] || {attempts:0, correct:0, wrong:0};
    const choices = q.choices.map((c,k)=>{
      const isCorrect = (k===q.answer);
      const chosen = (a === k);
      let cls = "choice";
      if (isCorrect) cls += " correct";
      if (chosen && !isCorrect) cls += " wrong";
      if (chosen) cls += " selected";
      return `<div class="${cls}"><b>${(k+1)}</b>. ${c.replace(/</g,"&lt;")}</div>`;
    }).join("");
    const origIdHtml = toggleOriginal.checked ? `<div class="pill">原始ID #${q.id}</div>` : "";
    const cleaned = cleanQuestion(q.question).replace(/</g,"&lt;");
    const showRemove = (!ok) || reviewSet.has(q.id);
    const controls = showRemove ? `<div class="inline-controls" style="margin-top:10px;">
        <button class="btn danger" data-action="removeReview" data-qid="${q.id}">移出複習清單</button>
      </div>` : "";
    return `
    <div class="card" data-qid="${q.id}">
      <div class="qhead">
        <div class="qid">題目 ${i+1} / ${order.length}</div>
        ${origIdHtml}
      </div>
      <div class="qstats">【作答次數: ${s.attempts}｜答對: ${s.correct}｜答錯: ${s.wrong}】</div>
      <div class="qtxt">${cleaned}</div>
      <div class="choices">${choices}</div>
      ${controls}
    </div>`;
  }).join("");

  quizEl.querySelectorAll('[data-action="removeReview"]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const qid = parseInt(btn.getAttribute('data-qid'),10);
      reviewSet.delete(qid);
      persist();
      btn.closest('.card')?.remove();
    });
  });
}

function toggleReviewForCurrent(){
  const q = order[idx];
  if(!q) return;
  if (reviewSet.has(q.id)) reviewSet.delete(q.id);
  else reviewSet.add(q.id);
  persist();
  render();
}
toggleReviewBtn.addEventListener('click', (e)=>{ toggleReviewForCurrent(); try{e.currentTarget.blur();}catch(err){} });

document.addEventListener('keydown', (e)=>{
  const t = e.target;
  const tag = (t && t.tagName) ? t.tagName.toLowerCase() : '';
  const isTyping = (tag==='input' || tag==='textarea' || tag==='select' || (t && t.isContentEditable));
  if (isTyping) return;

  if (!started) return;
  const mode = modeEl.value;
  if (mode==='exam' || mode==='review_list'){
    if (['1','2','3','4'].includes(e.key)){
      e.preventDefault(); e.stopPropagation();
      onPick(idx, parseInt(e.key)-1);
    } else if (e.key === '5' && mode==='exam'){
      e.preventDefault(); e.stopPropagation();
      toggleReviewForCurrent();
    } else if (e.key === 'Enter'){
      e.preventDefault(); e.stopPropagation();
      confirmCurrent();
    } else if (e.key === 'ArrowRight'){
      e.preventDefault(); e.stopPropagation();
      goNext();
    } else if (e.key === 'ArrowLeft'){
      e.preventDefault(); e.stopPropagation();
      goPrev();
    }
  }
});

el('#startBtn').addEventListener('click', ()=>{ started=false; showPreStartSummary(); });
el('#resetBtn').addEventListener('click', ()=>{
  answers = {}; revealed = {}; locked = {}; idx = 0; started = false;
  reviewSet.clear();
  stats = {};
  localStorage.removeItem(REVIEW_KEY);
  localStorage.removeItem(STATS_KEY);
  persist();
  render();
});
prevBtn.addEventListener('click', goPrev);
nextBtn.addEventListener('click', goNext);
confirmBtn.addEventListener('click', confirmCurrent);
el('#submitBtn').addEventListener('click', submit);
el('#exportReviewBtn').addEventListener('click', ()=>{
  const ids = Array.from(reviewSet);
  const blob = new Blob([JSON.stringify(ids, null, 2)], {type:"application/json"});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'ccse_review_ids.json';
  a.click();
});

modeEl.addEventListener('change', ()=>{
  answers = {}; revealed = {}; locked = {}; idx = 0;
  order = [];
  scoreBanner.classList.add('hidden');
  const mode = modeEl.value;
  if (mode === 'review_list_all') {
    started = true;
    const base = BANK.filter(q=>new Set(JSON.parse(localStorage.getItem('ccse_review_ids')||'[]')).has(q.id));
    order = base.slice().sort((a,b)=> (a.id||0)-(b.id||0));
    render();
  } else {
    started = false;
    render();
  }
});

toggleOriginal.addEventListener('change', ()=>{ persist(); render(); });
searchBtn.addEventListener('click', ()=>{
  if (!started){ started=true; startActual(); }
  order = BANK.slice().sort((a,b)=> (a.id||0)-(b.id||0));
  render();
});
clearSearchBtn.addEventListener('click', ()=>{
  searchInput.value = "";
  render();
});

updateHdr();
render();
</script>
</body>
</html>
